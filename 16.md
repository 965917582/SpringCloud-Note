![image-20210816173304303](16.assets/image-20210816173304303-1629106385414.png)

# 简介

![image-20210817084948620](16.assets/image-20210817084948620-1629161389525.png)

## 为什么叫nacos

![image-20210817085100450](16.assets/image-20210817085100450-1629161461299.png)

服务命名(注册)和配置



## 是什么

![image-20210817085135714](16.assets/image-20210817085135714-1629161496614.png)

![image-20210817085242218](16.assets/image-20210817085242218-1629161563106.png)



## 能干吗

![image-20210817090552792](16.assets/image-20210817090552792-1629162353616.png)



## 去哪下

![image-20210817090704474](16.assets/image-20210817090704474-1629162425219.png)

![image-20210817090934546](16.assets/image-20210817090934546-1629162575372.png)

github，官方中文网站，官方文档

阳哥的知识也是这样一点点儿抠出来的



## 注册中心比较

![image-20210817091226604](16.assets/image-20210817091226604-1629162747468.png)

# 安装并运行

![image-20210817091412035](16.assets/image-20210817091412035-1629162852933.png)



![image-20210817092403010](16.assets/image-20210817092403010-1629163443921.png)



![image-20210817092426171](16.assets/image-20210817092426171-1629163467305.png)





# 作为服务注册中心

![image-20210817092701948](16.assets/image-20210817092701948-1629163622685.png)

![image-20210817092915003](16.assets/image-20210817092915003-1629163755966.png)



## 服务提供者

![image-20210817093007845](16.assets/image-20210817093007845-1629163808694.png)

![image-20210817093037226](16.assets/image-20210817093037226-1629163838117.png)

![image-20210817093159889](16.assets/image-20210817093159889-1629163920836.png)



![image-20210817093232099](16.assets/image-20210817093232099-1629163952926.png)



```xml
<!--SpringCloud alibaba nacos-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

![image-20210817093418699](16.assets/image-20210817093418699-1629164059485.png)

![image-20210817093429451](16.assets/image-20210817093429451-1629164070202.png)



![image-20210817093515907](16.assets/image-20210817093515907-1629164116678.png)

```java
@SpringBootApplication
@EnableDiscoveryClient
public class NacosProviderDemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(NacosProviderDemoApplication.class,args);
    }
}
```



```java
@RestController
public class PaymentController {
    @Value("${server.port}")
    private String serverPort;

    @GetMapping(value = "/payment/nacos/{id}")
    public String getPayment(@PathVariable("id") Integer id){
        return "nacos registry , serverPort: "+serverPort+"\t id: "+id;
    }
}
```



![image-20210817095045099](16.assets/image-20210817095045099-1629165046133.png)



![image-20210817095355800](16.assets/image-20210817095355800-1629165236792.png)



#

![image-20210817095643746](16.assets/image-20210817095643746-1629165405165.png)

nacos是自带了负载均衡功能

![image-20210817095729803](16.assets/image-20210817095729803-1629165450758.png)

拷贝虚拟端口毕竟是虚拟的，玩玩就好

![image-20210817095822667](16.assets/image-20210817095822667-1629165504039.png)



![image-20210817095905904](16.assets/image-20210817095905904-1629165546709.png)





## 服务消费者

![image-20210817103712217](16.assets/image-20210817103712217-1629167833571.png)

![image-20210817103920019](16.assets/image-20210817103920019-1629167960938.png)



```yml
server:
  port: 83

spring:
  application:
    name: nacos-payment-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848

#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)
service-url:
  nacos-user-service: http://nacos-payment-provider
```



```java
@SpringBootApplication
@EnableDiscoveryClient
public class PaymentMain9002 {
    public static void main(String[] args) {
        SpringApplication.run(PaymentMain9002.class,args);
    }
}
```



因为集成了ribbon ，所以有restTemplate

```java
@Configuration
public class ApplicationContextConfig {

    @Bean
    @LoadBalanced
    public RestTemplate getRestTemplate(){
        return new RestTemplate();
    }
}
```



```java
@RestController
@Slf4j
public class OrderNacosController {
    @Resource
    private RestTemplate restTemplate;
    
    @Value("${service-url.nacos-user-service}")
    private String serverURL;
    
    @GetMapping(value = "/consumer/payment/nacos/{id}")
    public String paymentInfo(@PathVariable("id")Long id){
        return restTemplate.getForObject(serverURL+"/payment/nacos/"+id,String.class);
    }
}
```



![image-20210817105347747](16.assets/image-20210817105347747-1629168828731.png)

![image-20210817105700288](16.assets/image-20210817105700288-1629169021275.png)

![image-20210817105945313](16.assets/image-20210817105945313-1629169186353.png)

![image-20210817110007455](16.assets/image-20210817110007455-1629169208369.png)



![image-20210817110024750](16.assets/image-20210817110024750-1629169225496.png)

测试成功



## 注册中心对比

切换AP，CP

![image-20210817110156118](16.assets/image-20210817110156118-1629169316929.png)

![image-20210817110218496](16.assets/image-20210817110218496-1629169339522.png)

![image-20210817110242446](16.assets/image-20210817110242446-1629169363473.png)

nacos的野心：它想全景覆盖

![image-20210817110417507](16.assets/image-20210817110417507-1629169458506.png)



![image-20210817110454089](16.assets/image-20210817110454089-1629169495280.png)

![image-20210817110620701](16.assets/image-20210817110620701-1629169582338.png)



![image-20210817110636791](16.assets/image-20210817110636791-1629169597872.png)

用post命令切换并启动

# 作为服务配置中心

![image-20210817111010476](16.assets/image-20210817111010476-1629169811281.png)



![image-20210817111037413](16.assets/image-20210817111037413-1629169838243.png)



## 作为配置中心-基础配置

![image-20210817111122230](16.assets/image-20210817111122230-1629169882956.png)

```xml
<!--nacos config-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
<!--nacos discovery-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

![image-20210817111538790](16.assets/image-20210817111538790-1629170139857.png)

![image-20210817111552983](16.assets/image-20210817111552983-1629170153883.png)



bootstrap.yml:

```yml
server:
  port: 3377

spring:
  application:
    name: nacos-config-client
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  #Nacos服务注册中心的地址
      config:
        server-addr: localhost:8848  #Nacos作为配置中心的地址
        file-extension: yaml  #配置文件的格式

#${spring.application.name}-${spring.profile.active}.${spring.cloud.nacos.file-extension}
```



application.yml:

```yml
spring:
  profiles:
    active: dev  #表示开发环境
```



```java
@EnableDiscoveryClient
@SpringBootApplication
public class NacosConfigClientMain3377 {
    public static void main(String[] args) {
        SpringApplication.run(NacosConfigClientMain3377.class,args);
    }
}
```

![image-20210817112957727](16.assets/image-20210817112957727-1629170998738.png)



![image-20210817113200417](16.assets/image-20210817113200417-1629171121723.png)

![image-20210817113219422](16.assets/image-20210817113219422-1629171140307.png)



![image-20210817113245276](16.assets/image-20210817113245276-1629171166170.png)

![image-20210817113257923](16.assets/image-20210817113257923-1629171178779.png)



![image-20210817113339728](16.assets/image-20210817113339728-1629171220571.png)



![image-20210817114157393](16.assets/image-20210817114157393-1629171718316.png)

![image-20210817114214127](16.assets/image-20210817114214127-1629171734955.png)

![image-20210817114230290](16.assets/image-20210817114230290-1629171751435.png)



![image-20210817114404898](16.assets/image-20210817114404898-1629171846157.png)

![image-20210817141631080](16.assets/image-20210817141631080-1629180992044.png)

#测试

![image-20210817141733925](16.assets/image-20210817141733925-1629181055440.png)



![image-20210817141942430](16.assets/image-20210817141942430-1629181183248.png)

![image-20210817142255836](16.assets/image-20210817142255836-1629181376697.png)

![image-20210817142331388](16.assets/image-20210817142331388-1629181412908.png)

好方便啊！！！





## 作为配置中心-分类配置

这里是nacos分类管理厉害的地方

![image-20210817142547065](16.assets/image-20210817142547065-1629181547876.png)

#问题

![image-20210817142622929](16.assets/image-20210817142622929-1629181583859.png)

#nacos的图形化管理界面

![image-20210817142856351](16.assets/image-20210817142856351-1629181737501.png)

##配置管理

![image-20210817142932712](16.assets/image-20210817142932712-1629181773797.png)

##命名空间

![image-20210817143006397](16.assets/image-20210817143006397-1629181807394.png)



#命名空间+分组+dataid的关系，为什么这样设计

![image-20210817143116329](16.assets/image-20210817143116329-1629181877468.png)

![image-20210817143221629](16.assets/image-20210817143221629-1629181942548.png)

(图里service是微服务，cluster是集群)

![image-20210817143335519](16.assets/image-20210817143335519-1629182016531.png)



#进行分类配置

![image-20210817143807981](16.assets/image-20210817143807981-1629182288838.png)

##dataid方案

![image-20210817143924103](16.assets/image-20210817143924103-1629182364898.png)

![image-20210817144045583](16.assets/image-20210817144045583-1629182446539.png)



![image-20210817144331072](16.assets/image-20210817144331072-1629182612138.png)



##group方案

![image-20210817144617558](16.assets/image-20210817144617558-1629182778489.png)

![image-20210817144713120](16.assets/image-20210817144713120-1629182833970.png)

让不同组有同一个文件：

![image-20210817145032597](16.assets/image-20210817145032597-1629183034345.png)

![image-20210817145054653](16.assets/image-20210817145054653-1629183055482.png)

![image-20210817145116991](16.assets/image-20210817145116991-1629183078073.png)

![image-20210817145348270](16.assets/image-20210817145348270-1629183229170.png)

测试成功



##namespace方案

![image-20210817145441186](16.assets/image-20210817145441186-1629183282098.png)



![image-20210817145639440](16.assets/image-20210817145639440-1629183400347.png)



![image-20210817145829568](16.assets/image-20210817145829568-1629183510451.png)



![image-20210817145955766](16.assets/image-20210817145955766-1629183596851.png)

![image-20210817150059942](16.assets/image-20210817150059942-1629183660748.png)

![image-20210817150643078](16.assets/image-20210817150643078-1629184004404.png)

测试成功

三级工作空间，请大家在工作中务必使用



# 集群和持久化配置

![image-20210817150822892](16.assets/image-20210817150822892-1629184103865.png)

![image-20210817151155983](16.assets/image-20210817151155983-1629184316825.png)

如果不配持久，实际生产中会给你惹事的



## 官网说明

![image-20210817151854619](16.assets/image-20210817151854619-1629184735755.png)

![image-20210817151518527](16.assets/image-20210817151518527-1629184519524.png)

![image-20210817151544296](16.assets/image-20210817151544296-1629184545092.png)

(VIP:虚拟映射ip，就nginx)

#真实情况

![image-20210817151939383](16.assets/image-20210817151939383-1629184780225.png)

![image-20210817152030582](16.assets/image-20210817152030582-1629184831585.png)



![image-20210817152123823](16.assets/image-20210817152123823-1629184884820.png)

![image-20210817152710974](16.assets/image-20210817152710974-1629185231979.png)

![image-20210817152142684](16.assets/image-20210817152142684-1629184903556.png)

nacos有内嵌数据库，所以如果启动多个nacos节点，数据存储有一致性问题。

所以采用集中式存储

![image-20210817152418369](16.assets/image-20210817152418369.png)

![image-20210817152643896](16.assets/image-20210817152643896-1629185207245.png)



## 持久化配置解释

![image-20210817152904305](16.assets/image-20210817152904305-1629185345309.png)

![image-20210817152929878](16.assets/image-20210817152929878-1629185370789.png)

#

这个是nacos代码：

![image-20210817153021550](16.assets/image-20210817153021550-1629185423202.png)

可以看到用的是apache的derby



#

![image-20210817153124863](16.assets/image-20210817153124863-1629185485714.png)



![image-20210817153319167](16.assets/image-20210817153319167-1629185600140.png)



![image-20210817153941687](16.assets/image-20210817153941687-1629185982933.png)

![image-20210817154045068](16.assets/image-20210817154045068-1629186046259.png)

测试成功



## linux版nacos+mysql生产环境配置

![image-20210817154257743](16.assets/image-20210817154257743-1629186178603.png)

#nacos下载linux版

![image-20210817154521023](16.assets/image-20210817154521023-1629186321875.png)

![image-20210817154545534](16.assets/image-20210817154545534-1629186346380.png)

很简单



#集群配置

![image-20210817170629159](16.assets/image-20210817170629159-1629191190086.png)

![image-20210817170715574](16.assets/image-20210817170715574-1629191236482.png)

##1

![image-20210817170904959](16.assets/image-20210817170904959-1629191346041.png)

![image-20210817171447916](16.assets/image-20210817171447916-1629191688913.png)



##2

![image-20210817171621170](16.assets/image-20210817171621170-1629191782449.png)

【一般动之前先备份成backup      cp xxxx.xx   xxxx.xx.bk】



##3

![image-20210817172205054](16.assets/image-20210817172205054-1629192126123.png)



![image-20210817172242001](16.assets/image-20210817172242001-1629192163049.png)

梳理一下集群端口号

![image-20210817172503284](16.assets/image-20210817172503284-1629192304322.png)

![image-20210817172625301](16.assets/image-20210817172625301-1629192386179.png)

![image-20210817172636585](16.assets/image-20210817172636585-1629192397634.png)

##4

![image-20210817173015203](16.assets/image-20210817173015203-1629192615953.png)

![image-20210817173104167](16.assets/image-20210817173104167-1629192664972.png)

![image-20210817173136208](16.assets/image-20210817173136208-1629192697130.png)



![image-20210817173403159](16.assets/image-20210817173403159-1629192844195.png)

![image-20210817173517462](16.assets/image-20210817173517462-1629192918333.png)

![image-20210817173702913](16.assets/image-20210817173702913-1629193024835.png)

不要害怕，一点点改

![image-20210817174006740](16.assets/image-20210817174006740-1629193207673.png)

![image-20210817174145236](16.assets/image-20210817174145236-1629193306059.png)



![image-20210817174534934](16.assets/image-20210817174534934-1629193536361.png)

##5

![image-20210817174611267](16.assets/image-20210817174611267-1629193572259.png)

![image-20210817174621873](16.assets/image-20210817174621873-1629193582681.png)



![image-20210817175003952](16.assets/image-20210817175003952-1629193804850.png)

启动：

![image-20210817180812150](16.assets/image-20210817180812150-1629194893214.png)

![image-20210817180934677](16.assets/image-20210817180934677-1629194975561.png)



##6

![image-20210817181032075](16.assets/image-20210817181032075-1629195033835.png)



老子的服务器1个nacos也跑不起来

![image-20210817182219516](16.assets/image-20210817182219516-1629195740395.png)



![image-20210817182231416](16.assets/image-20210817182231416-1629195752312.png)

![image-20210817182435558](16.assets/image-20210817182435558-1629195876386.png)



#测试

![image-20210817182831270](16.assets/image-20210817182831270-1629196112067.png)

![image-20210817182912038](16.assets/image-20210817182912038-1629196152964.png)

![image-20210817182933804](16.assets/image-20210817182933804-1629196174739.png)

#高可用小总结

![image-20210817183143929](16.assets/image-20210817183143929-1629196305355.png)

















